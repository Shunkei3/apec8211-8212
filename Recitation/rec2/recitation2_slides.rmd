---
title: "APEC8211: Recitation 2"
author: 
  - "Shunkei Kakimoto" 
header-includes:
   - \usepackage{mathtools}
   - \usepackage{color}
   - \usepackage{amsmath}
output:
  xaringan::moon_reader:
    self_contained: true
    css: xaringan-themer.css 
    lib_dir: libs
    nature: 
      highlightStyle: github
      highlightLines: true
---
class: middle

```{r, child = 'setup.rmd', cache = FALSE}
```

```{r, include = F, cache = FALSE}
# here::i_am("GitControlled/Recitation/1_Introduction/recitation1_slides.rmd")
```


```{r, include = F, cache = FALSE}
library(data.table)
library(ggplot2)
library(dplyr)
library(gganimate)
library(ggtext)
library(gifski)
library(gganimate)
```

```{r, include = F, eval=F, cache = FALSE}
httpgd::hgd()
httpgd::hgd_browse()
```

# Outline

Review some concepts related to random variables

[1. CDF, PDF, PMF](#dist)

[2. Mean, variance and covariance](#mean)

[3. Jensen's inequality](#Jensen)

---
name: dist
# CDF, PDF, PMF, Quantile function
.content-box-red[**CDF**]
+ Definition: <span style="color:red">The CDF of a random variable X is $F(x) = Pr[X \leq x]$</span>
+ **Verbally**: CDF $F(x)$ tells us the probability of the event that random variable $X$ is less than a value $x$. 

.left5[
```{r, echo=F}
# Define sequence of x-values  
x <-  seq(-4, 4, .01)
# CDF plot for a continuous variable
cdf_x <- pnorm(x)
# plot normal CDF
plot(
  x, cdf_x, type="l",
  xlab = "X",
  ylab = "Probability",
  main = "Continuous distribution function"
)
```
]
.right5[
```{r, echo=F}
# https://stackoverflow.com/questions/66266703/draw-discrete-cdf-in-r
x <- -1:5
prob <- ppois(q = x, lambda = 3)
n <- length(x)

plot(x = NA, y = NA, pch = NA, 
     xlim = c(-1, max(x)), 
     ylim = c(0, 1),
     xlab = "X",
     ylab = "Probability",
     main = "Discrete distribution function"
)
points(x = x[-1], y = prob[-1], pch=19)
points(x = x[-1], y = prob[-n], pch=1)
for(i in 2:(n-1))
  points(x=x[i+0:1], y=prob[c(i,i)], type="l")
points(x=c(-2,x[2]), y=prob[c(1,1)], type="l")
points(x=c(x[n],6), y=prob[c(n,n)], type="l")
```
]

---
.content-box-red[**Probability mass function (Discrete random variables)**]
+ Definition: $\color{red}{\pi(x) = Pr[X = x]}$
+ **Verbally**: The probability that $X$ equals the value $x$

<br>

.content-box-red[**Probability density function (Continuous random variables)**] 
+ Definition:  $\color{red}{f(x) = \frac{d}{dx}F(x)} \quad ( = \displaystyle \lim_{x\to\infty} \frac{F(x+h)-F(x)}{h})$
+ **Verbally**: Density function is a 


<br>

.content-box-red[**Theorem 2.3: Properties of a PDF**] 

A function f(x) is a density function **if and only if** 

$$\begin{cases}
f(x) \ge 0 \text{ for all } x \\
\int_{x=-\infty}^\infty x\,dx = 1
\end{cases}$$

---
class: middle

.content-box-green[**Relationship between CDF and PDF**]

```{r, cache=F, echo=F}
# https://github.com/thomasp85/gganimate/wiki/Animation-Composition
# Placing Animations side-by-side with magick: https://tex.stackexchange.com/questions/515670/probability-density-function-and-cumulative-distribution-function-for-normal-dis
# How to Combine Animated Plots in R: https://towardsdatascience.com/how-to-combine-animated-plots-in-r-734c6c952315

# httpgd::hgd()
# httpgd::hgd_browse()

# /*===== Generate data =====*/
x <-  seq(-4, 4, 0.05)
y <- pnorm(x)
y_d <- dnorm(x)


plot_data <-data.table(x=x, y=y,y_d=y_d)


ls_res <- list()
ls_cut <- seq(-4,4,by=0.05) 
# ls_cut <- c(-3,4) 
for(i in 1:length(ls_cut)){
  ls_res[[i]] <- 
    plot_data[x <= ls_cut[i], ] %>%
    .[, time := ls_cut[i]]
}


res_all <- 
  rbindlist(ls_res) %>%
  .[,c_arrow_x := max(x), by=time] %>%
  .[,c_arrow_y := .SD[x==c_arrow_x,y], by=time] %>%
  .[,c_P_pos_x := ifelse(time<0, 0.3, -0.3)] %>%
  .[,d_arrow_x := 
    case_when(
      time < 0 ~ (-4+time)/2 + 0.5, 
      time >= 0 ~ (-4+time)/2 + 1, 
    )]
  # .[,d_arrow_y := 
  #   case_when(
  #     time <= -3 ~ 0,
  #     time > -3 & time <= -2 ~ 0.005,
  #     time > -2 & time <= -1 ~ 0.01,
  #     time > -1 & time <= -0 ~ 0.013,
  #     time > -2 & time <= -0 ~ 0.015,
  #     time >= 0 ~ 0.02
  #   )]




# /*===========================================*/
#'=  Demonstration =
# /*===========================================*/

# === Cumulative === #
# temp <- res_all[time==3]
# ggplot(data=temp)+
#   # --- base --- #
#   geom_line(data=plot_data, aes(x=x, y=y))+
#   geom_hline(aes(yintercept=0), color="darkgrey")+
#   geom_segment(
#     aes(x = 0, y = 0, xend = 0, yend = 1.05),
#     arrow = arrow(length = unit(0.01, "npc")),
#     color="darkgrey"
#     )+
#   # --- height --- #
#   geom_segment(
#     aes(x = c_arrow_x, y = 0, 
#         xend = c_arrow_x, yend = c_arrow_y),
#     arrow = arrow(length = unit(0.01, "npc"), ends = "both"), color="red"
#     )+
#   # --- horizontal line --- #
#   geom_segment(
#     aes(x = 0, y = c_arrow_y,
#         xend = c_arrow_x, yend = c_arrow_y),
#     linetype="dashed"
#     )+
#   # --- text: P --- #
#   geom_text(aes(x=c_P_pos_x, y=c_arrow_y, label="P"),size=4, color="red")+
#   theme_bw() 

# === Density === #
# temp <- res_all[time==4]

# ggplot(data=temp)+
#   # --- base --- #
#   geom_line(data=plot_data, aes(x=x, y=y_d))+
#   geom_hline(aes(yintercept=0), color="darkgrey")+
#   geom_segment(
#     aes(x = 0, y = 0, xend = 0, yend = 0.45),
#     arrow = arrow(length = unit(0.01, "npc")),
#     color="darkgrey"
#     )+
#   # --- fill color on the area--- #
#   geom_ribbon(
#     aes(ymax = y_d, ymin = 0, x = x),
#     fill = 'red', alpha = 0.4
#   ) +
#   # --- text: P --- #
#   geom_text(aes(x=0, y=-0.05, label="Area=P"),size=4, color="red")+
#   # --- arrow --- #
#   geom_segment(
#     aes(x = 0, y = -0.04,
#         xend = d_arrow_x, yend = d_arrow_y),
#     arrow = arrow(length = unit(0.01, "npc"))
#     )+
#   theme_bw()



# /*===========================================*/
#'=  Animation =
# /*===========================================*/

# === Cumulative (Animation)=== #
cdf_annimate <- 
  ggplot(data=res_all)+
  # --- base --- #
  geom_line(data=plot_data, aes(x=x, y=y))+
  geom_hline(aes(yintercept=0), color="darkgrey")+
  geom_segment(
    aes(x = 0, y = 0, xend = 0, yend = 1.05),
    arrow = arrow(length = unit(0.01, "npc")),
    color="darkgrey"
    )+
  # --- Vertical line --- #
  geom_vline(
    aes(xintercept = c_arrow_x), linetype = "dashed", size = 0.5
    )+
  # --- vertical red arrow --- #
  geom_segment(
    aes(x = c_arrow_x, y = 0, 
        xend = c_arrow_x, yend = c_arrow_y),
    arrow = arrow(length = unit(0.02, "npc"), ends = "both"), color="red", size = 2
    )+
  # --- horizontal line --- #
  geom_segment(
    aes(x = 0, y = c_arrow_y,
        xend = c_arrow_x, yend = c_arrow_y),
    linetype="dashed", size = 0.5
    # arrow = arrow(length = unit(0.01, "npc"))
    )+
  # --- text: P --- #
  geom_text(aes(x=c_P_pos_x, y=c_arrow_y, label="P"),size=6, color="red")+
  transition_time(time)+
  theme_bw() +
  labs(title="CDF", x="X", y="Probability") +
  theme(plot.title = element_text(hjust = 0.5))



# === Density (Animation)=== #
pdf_annimate <- 
  ggplot(data=res_all)+
  # --- base --- #
  geom_line(data=plot_data, aes(x=x, y=y_d))+
  geom_hline(aes(yintercept=0), color="darkgrey")+
  geom_segment(
    aes(x = 0, y = 0, xend = 0, yend = 0.45),
    arrow = arrow(length = unit(0.01, "npc")),
    color="darkgrey"
    )+
  # --- fill color on the area--- #
  geom_ribbon(
    aes(ymax = y_d, ymin = 0, x = x),
    fill = 'red', alpha = 0.4
  ) +
  # --- Vertical line --- #
  geom_vline(
    aes(xintercept = c_arrow_x), linetype = "dashed", size = 0.5
    )+
  # geom_segment(
  #   aes(x = x, y = 0, xend = x, yend = 0.4),
  #   linetype = "dashed"
  #   ) +
  # --- text: P --- #
  geom_text(aes(x=0, y=-0.05, label="P (Red area)"),size=6, color="red")+
  # --- arrow --- #
  geom_segment(
    aes(x = 0, y = -0.04,
        xend = d_arrow_x, yend = 0.001),
    arrow = arrow(length = unit(0.02, "npc"))
    )+
  transition_time(time)+
  theme_bw()+
  labs(title="PDF", x="X", y="Density") +
  theme(plot.title = element_text(hjust = 0.5))

```

```{r, cache=F, echo=F, out.width = "80%"}
cdf_gif <- 
  animate(
    cdf_annimate,
     width = 400, height = 420, duration = 15
     )

pdf_gif <- 
  animate(
    pdf_annimate, 
    width = 400, height = 420, duration = 15
    )

library(magick)
cdf_mgif <- image_read(cdf_gif)
pdf_mgif <- image_read(pdf_gif)


new_gif <- 
  image_append(
    c(cdf_mgif[1], pdf_mgif[1]),
    stack = FALSE
  )

for(i in 2:100){
  combined <- 
    image_append(
      c(cdf_mgif[i], pdf_mgif[i]), 
      stack = FALSE
    )
  new_gif <- c(new_gif, combined)
}
new_gif
```

---
# Mean, Variance and Covariance:
.content-box-red[**Mean: E[X]**]
+ Definition: <span style='color:red'>The mean of $X$ is $E[X]$</span>
+ How to calculate it?:
  * for discrete $X$?
  * for continuous $X$?

+ .content-box-green[Visualization]

```{r, echo=F, out.width = "50%"}
x_left = 2
x_right = 10
x_center = (x_left+x_right)/2
x <- seq(x_left, x_right, length = 1000)
y <- dnorm(x, mean = x_center, sd = 1)
plot_data <- data.table(x = x, y = y)

ggplot(data = plot_data) +
  geom_line(aes(x = x, y = y), color = "black")+
  labs(y="Density", title="Density of X ~ N(6,1)") +
  geom_vline(xintercept=x_center, color="red") +
  annotate("text",
    x = 7, y = 0.01,
    label = "Mean E[X]=6",
    size = 3, color="red"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```


---
# Mean, Variance and Covariance:
.content-box-red[**Variance: Var[X]**]
+ Definition: <span style='color:red'>The variance of $X$ is $Var[X]=E[(X-E[X])^2]$</span>
+ How to calculate it?
  * for discrete $X$?
  * for continuous $X$?

+ .content-box-green[Visualization]

```{r, echo=F, out.width = "50%"}
# /*===== Data generation =====*/
ls_res <- list()
ls_var <- c(1,4,9)

for (i in seq(1:length(ls_var))){
  var <- ls_var[i]
  x <- seq(x_left, x_right, length = 1000)
  y <- dnorm(x, mean = x_center, sd = sqrt(var))
  ls_res[[i]] <- data.table(var = var, x = x, y = y)
}

res_total <- rbindlist(ls_res)

# /*===== Visualization =====*/
ggplot(data = res_total) +
  geom_line(aes(x = x, y = y, color = interaction(var)))+
  labs(y = "Density", title = expression("Density of X ~ N(6," ~ sigma^2 ~ ") with various " ~ sigma^2)) +
  guides(color = guide_legend(title= expression(sigma^2 ~ "=")))+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```


---
# Mean, Variance and Covariance:
.content-box-red[**Coariance: Cov[X, Y]**]
+ Definition: <span style='color:red'>The covariance between X and Y are</span>

$$
\color{red}{Cov(X, Y) = E[(X-E[X])((Y-E[Y]))]}
$$
+ How to calculate it?
  * for discrete $X$?
  * for continuous $X$?

+ .content-box-green[Visualization]

```{r, echo=F, fig.dim = c(12, 3)}
# /*===== Data generation =====*/
ls_a <- c(-0.8, -0.5, 0, 0.5, 0.8)
n = 1000
ls_result <- list()

set.seed(123)
x <- rnorm(n, 3, sd=2)
z <- rnorm(n, 3, sd=2)

for (i in seq(1:length(ls_a))){  
  a <- ls_a[i]
  y <- a*x + abs(1-abs(a))*z
  ls_result[[i]] <- data.table(a = a, x = x, y = y)
}

results <- 
  rbindlist(ls_result) %>%
  .[,type := paste0("Cov(X,Y)=",round(cov(x,y), digits = 1)), by=a]

# /*===== Visualization =====*/
ggplot(data = results)+
  geom_point(aes(x = x, y = y), size = 0.5)+
  facet_wrap(~ factor(type, unique(results$type)), scale = "free", nrow = 1)+
  labs(x = "X", y = "Y", title = "Plots of random variables (X,Y) with different sizes of covariances")+
  theme_bw()+
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

---
class: middle

# Expectation, Variance and Covariance as operators
In Econometrics analysis, we often use $E[\,]$, $Var[\,]$, $Cov[\,]$ as operators (i.e., functions). The following are useful knowledge that you should know. 

---
class: middle

.content-box-red[**Expectation**] 

<span style="color:blue">Expectation is a linear operator.</span>

That is, for any constants $a$ and $b$ and any random variables $X$ and $Y$:

(1) $E[a+bX]=a+bE[X]$

(2) $E[X+Y]=E[X]+E[Y]$

+ Note: Linearity of expectation only applies to the sum of random variables (random variables are in the linear function) 
<!-- + A function $g(x)$ called a linear operator if (1) $f(x+y)=f(x)+f(y)$, and (2) $g(cx)=cg(x)$ for all $x$ and constant $c$.  -->

.content-box-green[**Question**]
+ True or False: $E[X+X^2]=E[X]+E[X^2]$?
+ True or False: $E[XY]=E[X]E[Y]$

---
class: middle

.content-box-red[**Variance**]

<span style="color:blue">Variance is not a linear operator except for special case.</span>

For any constants $a$ and $b$ and any random variables $X$ and $Y$:

(1) $Var[X]=E[X^2] - (E[X])^2 \quad (\text{Simply, another definition of } Var[X]$ )

(2) $Var[aX]=a^2Var[X]$

(3) $Var[a+bX]=b^2Var[X]$

(4) $Var[X+Y]=Var[X]+Var[Y] + Cov(X, Y)$

.content-box-green[**Question**]
+ In what condition does $Var[X+Y]=Var[X]+Var[Y]$ hold?


.content-box-green[**Exercise**]
+ Let's prove (1) and (2) 

---
class: middle

.content-box-red[**Visualization**]

For any constants $a$ and $b$ and any random variables $X$ and $Y$:

(1) $Cov[X, Y]=E[XY]-E[X]E[Y] \quad (\text{Simply, another definition of } Cov[X, Y]$)

(2) $Cov[aX, Y]=aCov[X,Y]$

(3) $Cov[X, a+bY]=bCov[X,Y]$

.content-box-green[**Question**]
+ In what condition does $Cov[X, Y]=0$ hold?

.content-box-green[**Exercise**]
+ Let's prove (1)-(3)

---

# Jensen's inequality
In the previous slide, we saw $Var[X]=E[(X-E[X])^2]=E[X^2] - (E[X])^2$. So, $Var[X] \ge 0$ (by the way, $Var[X]=0$ if and only if $X$ is degenerate). 

So, 
$$E[X^2] - (E[X])^2 \ge 0$$
<p style="text-align: center;">or</p>
$$(E[X])^2 \leq E[X^2]$$
Define $g(x)=x^2$. The it is written as
$$g(E[X]) \leq E[g(X)]$$

Generally, 
$$\begin{align*}
g(E[X]) \leq E[g(X)] \quad &\text{if } g(x) \text{ is a convex function} \\
E[g(X)] \leq g(E[X]) \quad &\text{if } g(x) \text{ is a concave function}
\end{align*}$$

---
.content-box-green[**Visualization**]

.panelset[ 

.panel[.panel-name[Example 1 : g(x) is convex]
.left5[
```{r, echo=T}
set.seed(356)
x <- runif(1000, 0, 10)

# /*===== Convex case: g(X)=X^2 =====*/
y <- x^2

figure_ex1 <-
  ggplot()+
  geom_point(aes(x = x, y = y))+
  # --- E[X] --- #
  geom_vline(xintercept = mean(x), color = "red", linetype = "dashed")+
  annotate("text", x = mean(x)+1, y = 0.01,
    label = paste0("E[X]=", round(mean(x), 1)), size = 3, color = "red") +
  # --- E[g(X)] --- #
  geom_hline(yintercept = mean(y), color="blue", linetype = "dashed")+
  annotate("text", x = 1, y = mean(y)+5,
    label = paste0("E[g(X)]=", round(mean(y), 1)), size = 3, color = "blue") +
  # --- g(E[X]) --- #
  geom_hline(yintercept = mean(x)^2, color="green", linetype = "dashed")+
  annotate("text", x = 1, y = mean(x)^2-5,
    label = paste0("g(E(X))=", round(mean(x)^2, 1)), size = 3, color = "green") +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```
  ]
.right5[
```{r, echo=F, out.width = "100%"}
figure_ex1
```

$$\color{lightgreen}{g(E[X])} \leq \color{blue}{E[g(X)]}$$
  ]
]

.panel[.panel-name[Example 2: g(x) is concave]
.left5[
```{r, echo=T, out.width = "50%"}
# /*===== Convex case: g(X)=X^(1/2) =====*/
y <- x^(1/2)

figure_ex2 <-
  ggplot()+
  geom_point(aes(x = x, y = y))+
  # --- E[X] --- #
  geom_vline(xintercept = mean(x), color = "red", linetype = "dashed")+
  annotate("text", x = mean(x)+0.8, y = 0.01,
    label = paste0("E[X]=", round(mean(x), 1)), size = 3, color = "red") +
  # --- E[g(X)] --- #
  geom_hline(yintercept = mean(y), color = "blue", linetype = "dashed")+
  annotate("text", x = 1, y = mean(y)-0.2,
    label = paste0("E[g(X)]=", round(mean(y), 2)), size = 3, color = "blue") +
  # --- g(E[X]) --- #
  geom_hline(yintercept = mean(x)^(1/2), color = "green", linetype = "dashed")+
  annotate("text", x = 1, y = mean(x)^(1/2)+0.2,
    label = paste0("g(E(X))=", round(mean(x)^(1/2), 2)), size = 3, color = "green") +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```
  ]
.right5[
```{r, echo=F, out.width = "100%"}
figure_ex2
```
$$\color{blue}{E[g(X)]} \leq \color{lightgreen}{g(E[X])}$$
  ]
]
]

